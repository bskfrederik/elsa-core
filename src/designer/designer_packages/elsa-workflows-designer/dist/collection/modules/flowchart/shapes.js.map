{"version":3,"file":"shapes.js","sourceRoot":"","sources":["../../../src/modules/flowchart/shapes.ts"],"names":[],"mappings":"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","sourcesContent":["import {Cell, Graph, Shape} from '@antv/x6';\nimport {Container} from 'typedi';\nimport {Activity, ActivityDescriptor} from '../../models';\nimport {ActivityDriverRegistry, ActivityDisplayContext} from '../../services';\n\nexport class ActivityNodeShape extends Shape.HTML {\n  get text() {\n    return this.store.get<string>('text');\n  }\n\n  set text(value: string) {\n    this.store.set('text', value);\n  }\n\n  get activity(): Activity {\n    return this.store.get<Activity>('activity');\n  }\n\n  set activity(value: Activity) {\n    this.store.set('activity', value);\n  }\n\n  get activityDescriptor(): ActivityDescriptor {\n    return this.store.get<ActivityDescriptor>('activityDescriptor');\n  }\n\n  set activityDescriptor(value: ActivityDescriptor) {\n    this.store.set('activityDescriptor', value);\n  }\n\n  init() {\n    super.init();\n    this.updateSize();\n  }\n\n  setup() {\n    const self = this;\n    super.setup();\n    this.on('change:text', this.updateSize, this);\n    this.on('change:activity', this.updateSize, this);\n\n    this.html = {\n      render() {\n\n        return self.createHtml();\n\n      },\n      shouldComponentUpdate(node: Cell) {\n        return node.hasChanged('text') || node.hasChanged('activity');\n      },\n    };\n  }\n\n  updateSize() {\n    const activityDescriptor = this.activityDescriptor as ActivityDescriptor;\n\n    if (!activityDescriptor)\n      return;\n\n    const wrapper = document.createElement('div');\n    wrapper.className = 'tw-inline-block tw-flex tw-items-center tw-pl-10 tw-pr-2 tw-py-2 tw-absolute';\n    wrapper.style.left = '-1000px';\n    wrapper.style.top = '-1000px';\n    wrapper.innerHTML = this.createHtml();\n\n    // Append the temporary element to the DOM.\n    // Important: this needs to be a child of the elsa-studio element, otherwise the tailwind CSS classes will not be applied due to the \"important\" rule in tailwind.config.js.\n    const elsaStudioElement = document.getElementsByTagName('elsa-flowchart')[0];\n    console.log(elsaStudioElement)\n    elsaStudioElement.append(wrapper);\n\n    // Wait for activity element to be completely rendered.\n    // When using custom elements, they are rendered after they are mounted. Before then, they have a 0 width and height.\n    const tryUpdateSize = () => {\n      const activityElement: Element = wrapper.getElementsByTagName('elsa-default-activity-template')[0];\n      const activityElementRect = activityElement.getBoundingClientRect();\n\n      // If the custom element has no width or height yet, it means it has not yet rendered.\n      if (activityElementRect.width == 0 || activityElementRect.height == 0) {\n\n        // Request an animation frame and call ourselves back immediately after.\n        window.requestAnimationFrame(tryUpdateSize);\n        return;\n      }\n\n      const rect = wrapper.firstElementChild.getBoundingClientRect();\n      const width = rect.width;\n      const height = rect.height;\n\n      // Update size of the activity node.\n      this.prop({size: {width, height}});\n\n      // Remove the temporary element (used only to calculate its size).\n      wrapper.remove();\n    };\n\n    // Begin try to get our element size.\n    tryUpdateSize();\n  }\n\n  createHtml() {\n    const activityDescriptor = this.activityDescriptor as ActivityDescriptor;\n    const activity = this.activity as Activity;\n    const activityType = activityDescriptor.typeName;\n    const driverRegistry = Container.get(ActivityDriverRegistry);\n    const driver = driverRegistry.createDriver(activityType);\n\n    const displayContext: ActivityDisplayContext = {\n      activity: activity,\n      activityDescriptor: activityDescriptor,\n      displayType: \"designer\"\n    };\n\n    return driver.display(displayContext);\n  }\n}\n\nActivityNodeShape.config({\n  ports: {\n    groups: {\n      left: {\n        position: 'left',\n        attrs: {\n          circle: {\n            r: 5,\n            magnet: true,\n            stroke: '#3c82f6',\n            strokeWidth: 2,\n            fill: '#fff',\n          },\n          text: {\n            fontSize: 12,\n            fill: '#888',\n          },\n        },\n        label: {\n          position: {\n            name: 'outside',\n          },\n        },\n      },\n      right: {\n        position: 'right',\n        attrs: {\n          circle: {\n            r: 5,\n            magnet: true,\n            stroke: '#3c82f6',\n            strokeWidth: 2,\n            fill: '#fff',\n          },\n          text: {\n            fontSize: 12,\n            fill: '#888',\n          },\n        },\n        label: {\n          position: {\n            name: 'outside',\n          },\n        },\n      },\n      top: {\n        position: 'top',\n        attrs: {\n          circle: {\n            r: 5,\n            magnet: true,\n            stroke: '#3c82f6',\n            strokeWidth: 2,\n            fill: '#fff',\n          },\n          text: {\n            fontSize: 12,\n            fill: '#888',\n          },\n        },\n        label: {\n          position: {\n            name: 'outside',\n          },\n        },\n      },\n      bottom: {\n        position: 'bottom',\n        attrs: {\n          circle: {\n            r: 5,\n            magnet: true,\n            stroke: '#3c82f6',\n            strokeWidth: 2,\n            fill: '#fff',\n          },\n          text: {\n            fontSize: 12,\n            fill: '#888',\n          },\n        },\n        label: {\n          position: {\n            name: 'outside',\n          },\n        },\n      },\n    },\n  },\n});\n\nGraph.registerNode('activity', ActivityNodeShape, true);\n"]}