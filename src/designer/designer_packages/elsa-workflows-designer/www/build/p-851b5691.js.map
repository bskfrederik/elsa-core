{"version":3,"names":["ActivityNodeClass","constructor","activity","this","parents","children","nodeId","ancestorIds","ancestors","reverse","map","x","id","length","join","_activity","value","_parents","_children","descendants","list","child","push","parent","siblings","flatMap","siblingsAndCousins","createActivityLookup","nodes","node","createActivityNodeMap","walkActivities","root","descriptors","descriptorsStore","activityDescriptors","collectedActivities","Set","graph","collectedNodes","walkRecursive","flatten","flattenList","activities","childList","ports","getPorts","port","collectedNodesArray","Array","from","childNode","find","has","add","includes","portProviderRegistry","Container","get","PortProviderRegistry","portProvider","type","activityDescriptor","typeName","getOutboundPorts","activityPorts","portProviderContext","resolvePort","name","isArray"],"sources":["./src/services/activity-walker.ts"],"sourcesContent":["import 'reflect-metadata';\r\nimport {camelCase} from 'lodash';\r\nimport {Container} from \"typedi\"\r\nimport {Activity, ActivityDescriptor} from \"../models\";\r\nimport {PortProviderRegistry} from \"./port-provider-registry\";\r\nimport descriptorsStore from '../data/descriptors-store';\r\nimport {Hash} from \"../utils\";\r\nimport {PortProviderContext} from \"./port-provider\";\r\n\r\nexport interface ActivityNode {\r\n  activity: Activity;\r\n  parents: Array<ActivityNode>;\r\n  children: Array<ActivityNode>;\r\n  port?: string;\r\n  nodeId: string;\r\n\r\n  descendants(): Array<ActivityNode>;\r\n\r\n  ancestors(): Array<ActivityNode>;\r\n\r\n  siblings(): Array<ActivityNode>;\r\n\r\n  siblingsAndCousins(): Array<ActivityNode>;\r\n}\r\n\r\nexport interface ActivityPort {\r\n  activity: Activity;\r\n  port: string;\r\n}\r\n\r\nexport class ActivityNodeClass implements ActivityNode {\r\n  private _activity: Activity;\r\n  private _parents: Array<ActivityNode>;\r\n  private _children: Array<ActivityNode>;\r\n\r\n  constructor(activity) {\r\n    this.activity = activity;\r\n    this.parents = [];\r\n    this.children = [];\r\n  }\r\n\r\n  get nodeId() {\r\n    const ancestorIds = [...this.ancestors()].reverse().map(x => x.activity.id);\r\n    return ancestorIds.length ? `${ancestorIds.join(\":\")}:${this.activity.id}` : this.activity.id;\r\n  }\r\n\r\n  get activity() {\r\n    return this._activity;\r\n  }\r\n\r\n  set activity(value) {\r\n    this._activity = value;\r\n  }\r\n\r\n  get parents() {\r\n    return this._parents;\r\n  }\r\n\r\n  set parents(value) {\r\n    this._parents = value;\r\n  }\r\n\r\n  get children() {\r\n    return this._children;\r\n  }\r\n\r\n  set children(value) {\r\n    this._children = value;\r\n  }\r\n\r\n  descendants() {\r\n    const list = [];\r\n\r\n    for (let child of this.children) {\r\n      list.push(child);\r\n      list.push(...child.descendants());\r\n    }\r\n\r\n    return list;\r\n  }\r\n\r\n  ancestors() {\r\n    const list = [];\r\n\r\n    for (let parent of this.parents) {\r\n      list.push(parent);\r\n      list.push(...parent.ancestors());\r\n    }\r\n\r\n    return list;\r\n  }\r\n\r\n  siblings() {\r\n    return this.parents.flatMap(parent => parent.children);\r\n  }\r\n\r\n  siblingsAndCousins() {\r\n    return this.parents.flatMap(parent => parent.descendants().flatMap(x => x.children));\r\n  }\r\n}\r\n\r\n\r\nexport function createActivityLookup(nodes: Array<ActivityNode>): Hash<Activity> {\r\n  const map = {};\r\n\r\n  for (const node of nodes)\r\n    map[node.activity.id] = node.activity;\r\n\r\n  return map;\r\n}\r\n\r\nexport function createActivityNodeMap(nodes: Array<ActivityNode>): Hash<ActivityNode> {\r\n  const map = {};\r\n\r\n  for (const node of nodes)\r\n    map[node.activity.id] = node;\r\n\r\n  return map;\r\n}\r\n\r\nexport function walkActivities(root: Activity): ActivityNode {\r\n  const descriptors = descriptorsStore.activityDescriptors;\r\n  const collectedActivities = new Set<Activity>([root]);\r\n  const graph: ActivityNode = new ActivityNodeClass(root);\r\n  const collectedNodes = new Set<ActivityNode>([graph]);\r\n\r\n  walkRecursive(graph, root, collectedActivities, collectedNodes, descriptors);\r\n  return graph;\r\n}\r\n\r\nexport function flatten(root: ActivityNode): Array<ActivityNode> {\r\n  return flattenList([root]);\r\n}\r\n\r\nexport function flattenList(activities: Array<ActivityNode>): Array<ActivityNode> {\r\n  let list: Array<ActivityNode> = [...activities];\r\n\r\n  for (const activity of activities) {\r\n    const childList = flattenList(activity.children);\r\n    list = [...list, ...childList];\r\n  }\r\n\r\n  return list;\r\n}\r\n\r\nfunction walkRecursive(node: ActivityNode, activity: Activity, collectedActivities: Set<Activity>, collectedNodes: Set<ActivityNode>, descriptors: Array<ActivityDescriptor>) {\r\n  const ports = getPorts(node, activity, descriptors);\r\n\r\n  for (const port of ports) {\r\n    const collectedNodesArray = Array.from(collectedNodes);\r\n    let childNode = collectedNodesArray.find(x => x.activity == port.activity);\r\n\r\n    if (!childNode) {\r\n      childNode = new ActivityNodeClass(port.activity);\r\n      childNode.port = port.port;\r\n      //childNode = {activity: port.activity, children: [], parents: [], port: port.port};\r\n\r\n      if (!collectedNodes.has(childNode))\r\n        collectedNodes.add(childNode);\r\n    }\r\n\r\n    if (childNode !== node) {\r\n      if (!!childNode.activity) {\r\n        if (!childNode.parents.includes(node))\r\n          childNode.parents.push(node);\r\n\r\n        if (!node.children.includes(childNode))\r\n          node.children.push(childNode);\r\n\r\n        if (!collectedActivities.has(port.activity))\r\n          collectedActivities.add(port.activity);\r\n\r\n        walkRecursive(childNode, port.activity, collectedActivities, collectedNodes, descriptors);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction getPorts(node: ActivityNode, activity: Activity, descriptors: Array<ActivityDescriptor>): Array<ActivityPort> {\r\n  const portProviderRegistry = Container.get(PortProviderRegistry);\r\n  const portProvider = portProviderRegistry.get(activity.type);\r\n  const activityDescriptor = descriptors.find(x => x.typeName == activity.type);\r\n  const ports = portProvider.getOutboundPorts({activity, activityDescriptor});\r\n  let activityPorts: Array<ActivityPort> = [];\r\n\r\n  const portProviderContext: PortProviderContext = {\r\n    activityDescriptor,\r\n    activity\r\n  };\r\n\r\n  for (const port of ports) {\r\n    const value = portProvider.resolvePort(port.name, portProviderContext);\r\n\r\n    if (Array.isArray(value)) {\r\n      const activities = value as Array<Activity>;\r\n      activityPorts = [...activityPorts, ...activities.map(x => ({port: port.name, activity: x}))];\r\n    } else {\r\n      activityPorts.push({port: port.name, activity: value});\r\n    }\r\n  }\r\n\r\n  return activityPorts;\r\n}\r\n"],"mappings":"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"}