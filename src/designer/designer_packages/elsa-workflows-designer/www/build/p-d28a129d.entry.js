import{r as t,h as s,a as e,c as i}from"./p-a7a3baa1.js";import{I as n}from"./p-6e6754a9.js";import{s as o}from"./p-b6964c5d.js";import{h as l}from"./p-ddecd487.js";import{ag as a,C as r,x as c,B as d,o as w,f as h,r as u,g as f,h as p,a0 as m}from"./p-691e5295.js";import"./p-219f806a.js";import{g}from"./p-e754efd8.js";import{w as v,f as x}from"./p-851b5691.js";import"./p-144a434e.js";import"./p-72dc819a.js";import"./p-e71312f9.js";const y=class{constructor(e){t(this,e);this.findActivityDescriptor=()=>{const t=this.activity;if(!t)return null;const s=o.activityDescriptors.find((s=>s.typeName==t.type&&s.version==t.version));return s!==null&&s!==void 0?s:o.activityDescriptors.sort(((t,s)=>s.version-t.version)).find((t=>t.typeName==this.activity.type))};this.onSelectedTabIndexChanged=t=>this.selectedTabIndex=t.detail.selectedTabIndex;this.renderPropertiesTab=()=>{var t,e,i;const o=this.activity;const l=this.findActivityDescriptor();const a=l.inputs.filter((t=>t.isBrowsable));const r=o.id;const c=(e=(t=o.metadata)===null||t===void 0?void 0:t.displayText)!==null&&e!==void 0?e:"";const d=this.activityExecutionLog;const w=(i=d===null||d===void 0?void 0:d.activityState)!==null&&i!==void 0?i:{};const h={[this.strings.propertiesTabActivityId]:r,[this.strings.propertiesTabDisplayText]:c};for(const t of a){const s=t.name;const e=w[s];const i=e!==null&&typeof e==="object"?JSON.stringify(e):e!=null?e.toString():"";h[t.displayName]=i}return s("div",null,s(n,{title:this.strings.propertiesTab,dictionary:h}))};this.renderCommonTab=()=>s("div",null);this.renderJournalTab=()=>{var t;const e=this.activityExecutionLog;if(e==null)return;const i=(t=e.payload)===null||t===void 0?void 0:t.exception;const n=e.eventName=="Completed"?"tw-bg-blue-100":e.eventName=="Faulted"?"tw-bg-red-100":"tw-bg-green-100";const o=this.iconRegistry.getOrDefault(e.activityType)({size:a.Small});return s("div",{class:"tw-border-2 tw-cursor-pointer tw-p-4 tw-rounded"},s("div",{class:"tw-relative tw-pb-10"},s("div",{class:"tw-relative tw-flex tw-space-x-3"},s("div",null,s("span",{class:`tw-h-8 tw-w-8 tw-rounded tw-p-1 tw-bg-blue-500 tw-flex tw-items-center tw-justify-center tw-ring-8 tw-ring-white tw-mr-1`},o)),s("div",{class:"tw-min-w-0 tw-flex-1 tw-pt-1.5 tw-flex tw-justify-between tw-space-x-4"},s("div",null,s("h3",{class:"tw-text-lg tw-leading-6 tw-font-medium tw-text-gray-900"},e.activityType)),s("div",null,s("span",{class:`tw-relative tw-inline-flex tw-items-center tw-rounded-full ${n} tw-border tw-border-gray-300 tw-px-3 tw-py-0.5 tw-text-sm`},s("span",{class:"tw-absolute tw-flex-shrink-0 tw-flex tw-items-center tw-justify-center"},s("span",{class:`tw-h-1.5 tw-w-1.5 tw-rounded-full`,"aria-hidden":"true"})),s("span",{class:"tw-font-medium tw-text-gray-900"},e.eventName))),s("div",{class:"tw-text-right tw-text-sm tw-whitespace-nowrap tw-text-gray-500"},s("span",null,l(e.timestamp).format("DD-MM-YYYY HH:mm:ss"))))),s("div",{class:"tw-ml-12 tw-mt-2"},s("dl",{class:"sm:tw-divide-y sm:tw-divide-gray-200"},s("div",{class:"tw-grid tw-grid-cols-2 tw-gap-x-4 tw-gap-y-8 sm:tw-grid-cols-2"},s("div",{class:"sm:tw-col-span-2"},s("dt",{class:"tw-text-sm tw-font-medium tw-text-gray-500"},s("span",null,this.strings.journalTabActivityId),s("copy-button",{value:e.activityId})),s("dd",{class:"tw-mt-1 tw-text-sm tw-text-gray-900 tw-mb-2"},e.activityId)),!!i?[s("div",{class:"sm:tw-col-span-2"},s("dt",{class:"tw-text-sm tw-font-medium tw-text-gray-500"},s("span",null,this.strings.journalTabException),s("copy-button",{value:i.Type+"\n"+i.Message})),s("dd",{class:"tw-mt-1 tw-text-sm tw-text-gray-900"},i.message)),s("div",{class:"sm:tw-col-span-2"},s("dt",{class:"tw-text-sm tw-font-medium tw-text-gray-500"},s("span",null,"Exception Details"),s("copy-button",{value:JSON.stringify(i,null,1)})),s("dd",{class:"tw-mt-1 tw-text-sm tw-text-gray-900 tw-overflow-x-auto"},s("pre",null,JSON.stringify(i,null,1))))]:undefined)))))};this.activity=undefined;this.activityExecutionLog=undefined;this.activityPropertyTabIndex=undefined;this.selectedTabIndex=0;this.iconRegistry=r.get(c)}async show(){await this.slideOverPanel.show()}async hide(){await this.slideOverPanel.hide()}async updateSelectedTab(t){this.selectedTabIndex=t}async componentWillLoad(){this.strings=await g(this.element);console.log(this.strings);if(this.activityPropertyTabIndex!=null){this.selectedTabIndex=this.activityPropertyTabIndex}}render(){const t=this.activity;const e=this.findActivityDescriptor();const i={displayText:this.strings.propertiesTab,content:()=>this.renderPropertiesTab()};const n={displayText:this.strings.commonTab,content:()=>this.renderCommonTab()};const o={displayText:this.strings.journalTab,content:()=>this.renderJournalTab()};const l=!!e?[i,n,o]:[];const a=t.id;const r=e.displayName;return s("elsa-form-panel",{mainTitle:a,subTitle:r,tabs:l,selectedTabIndex:this.selectedTabIndex,onSelectedTabIndexChanged:t=>this.onSelectedTabIndexChanged(t)})}get element(){return e(this)}static get watchers(){return{activity:["componentWillLoad"]}}};const b={Displaying:"workflow-instance-properties:displaying"};const k=class{constructor(e){t(this,e);this.createModel=async()=>{const t={tabModels:[]};const e=this.workflowDefinition;const i=this.workflowInstance;if(!e||!i){this.model=t;return}const o={name:"properties",tab:null,Widgets:[{name:"workflowInstanceInfo",content:()=>{const t={[this.strings.propertiesTabInstanceId]:w(i.id)?this.strings.propertiesNew:i.id,[this.strings.propertiesTabDefinitionId]:w(e.definitionId)?this.strings.propertiesNew:e.definitionId,[this.strings.propertiesTabVersion]:e.version.toString()};const o={[this.strings.propertiesTabStatus]:i.status,[this.strings.propertiesTabSubStatus]:i.subStatus};const l={[this.strings.propertiesTabCreated]:h(i.createdAt),[this.strings.propertiesTabLastExecution]:h(i.updatedAt),[this.strings.propertiesTabFinished]:h(i.finishedAt)};return s("div",null,s(n,{title:this.strings.propertiesTab,dictionary:t}),s(n,{title:this.strings.propertiesTabStatus,dictionary:o}),s(n,{title:this.strings.propertiesTabTimeStamps,dictionary:l,hideEmptyValues:true}))},order:10}]};o.tab={displayText:this.strings.propertiesTab,content:()=>this.renderPropertiesTab(o)};const l={name:"variables",tab:{displayText:this.strings.variablesTab,content:()=>this.renderVariablesTab()}};t.tabModels=[o,l];const a={model:t};await this.eventBus.emit(b.Displaying,this,a);this.model=t};this.renderPropertiesTab=t=>{const e=t.Widgets.sort(((t,s)=>t.order<s.order?-1:t.order>s.order?1:0));return s("div",null,e.map((t=>t.content())))};this.renderVariablesTab=()=>{var t,e;const i=(e=(t=this.workflowDefinition)===null||t===void 0?void 0:t.variables)!==null&&e!==void 0?e:[];return s("div",null,s("elsa-variables-viewer",{variables:i,workflowDefinition:this.workflowDefinition,workflowInstance:this.workflowInstance}))};this.onSelectedTabIndexChanged=t=>this.selectedTabIndex=t.detail.selectedTabIndex;this.workflowDefinition=undefined;this.workflowInstance=undefined;this.model=undefined;this.selectedTabIndex=0;this.changeHandle={};this.eventBus=r.get(d);this.model={tabModels:[]}}async show(){await this.slideOverPanel.show()}async hide(){await this.slideOverPanel.hide()}async onWorkflowDefinitionChanged(){await this.createModel()}async onWorkflowInstanceChanged(){await this.createModel()}async componentWillLoad(){this.strings=await g(this.element);await this.createModel()}render(){const t=this.workflowDefinition;const e=!w(t===null||t===void 0?void 0:t.name)?t.name:"-";const i="Workflow Instance";const n=this.model.tabModels.map((t=>t.tab));return s("elsa-form-panel",{mainTitle:e,subTitle:i,tabs:n,selectedTabIndex:this.selectedTabIndex,onSelectedTabIndexChanged:t=>this.onSelectedTabIndexChanged(t)})}get element(){return e(this)}static get watchers(){return{workflowDefinition:["onWorkflowDefinitionChanged"],workflowInstance:["onWorkflowInstanceChanged"]}}};const j="table.workflow-journal-table tbody tr td{padding-top:0.5rem;padding-bottom:0.5rem;padding-left:0.75rem;padding-right:0px}table.workflow-journal-table tbody tr td:first-child{padding-top:0.5rem;padding-bottom:0.5rem;padding-left:0.75rem;padding-right:0px}";const I=1e4;const C=class{constructor(e){t(this,e);this.journalItemSelected=i(this,"journalItemSelected",7);this.renderBlocks=t=>{const e=this.journalActivityMap;const i=this.iconRegistry;const n=this.expandedBlocks;const o=this.sortByTimestamp(t);return o.map((t=>{const o=e[t.nodeId];if(o==null)debugger;const l=o.activity;if(l.type=="Elsa.Workflow"||l.type=="Elsa.Flowchart")return this.renderBlocks(t.children);const r=l.metadata;const c=w(r.displayText)?l.id:r.displayText;const d=u(t.duration);const h=t.completed?"Completed":t.suspended?"Suspended":t.faulted?"Faulted":"Started";const p=i.getOrDefault(l.type)({size:a.Small});const m=!!n.find((s=>s==t));const g=t.completed?"tw-bg-blue-100":t.faulted?"tw-bg-red-100":"tw-bg-green-100";const v=m?s("svg",{class:"tw-h-6 tw-w-6 tw-text-gray-500",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"},s("path",{stroke:"none",d:"M0 0h24v24H0z"}),s("rect",{x:"4",y:"4",width:"16",height:"16",rx:"2"}),s("line",{x1:"9",y1:"12",x2:"15",y2:"12"})):s("svg",{class:"tw-h-6 tw-w-6 tw-text-gray-500",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"},s("path",{stroke:"none",d:"M0 0h24v24H0z"}),s("rect",{x:"4",y:"4",width:"16",height:"16",rx:"2"}),s("line",{x1:"9",y1:"12",x2:"15",y2:"12"}),s("line",{x1:"12",y1:"9",x2:"12",y2:"15"}));return[s("tr",null,s("td",{class:"tw-w-1"},t.children.length>0?s("a",{href:"#",onClick:s=>this.onBlockClick(s,t)},v):undefined),s("td",null,s("a",{href:"#",onClick:s=>this.onJournalItemClick(s,t,l)},f(t.timestamp))),s("td",{class:"tw-min-w-full"},s("div",{class:"tw-flex tw-items-center tw-space-x-1"},s("div",{class:"tw-flex-shrink"},s("div",{class:"tw-bg-blue-500 tw-rounded tw-p-1"},s("a",{href:"#",onClick:s=>this.onJournalItemClick(s,t,l)},p))),s("div",null,s("a",{href:"#",onClick:s=>this.onJournalItemClick(s,t,l)},c)))),s("td",null,s("a",{href:"#",onClick:s=>this.onJournalItemClick(s,t,l),class:`tw-inline-flex tw-rounded-full ${g} tw-px-2 tw-text-xs tw-font-semibold tw-leading-5 tw-text-green-800`},h)),s("td",null,s("a",{href:"#",onClick:s=>this.onJournalItemClick(s,t,l)},d))),m?this.renderBlocks(t.children):undefined]})).filter((t=>!!t))};this.loadJournalPage=async t=>{if(!this.model)return;const s=this.model.workflowInstance;const e=s.id;const i=await this.workflowInstancesApi.getJournal({page:t,pageSize:I,workflowInstanceId:e});const n=this.createBlocks(i.items);const o=n.filter((t=>!t.parentActivityInstanceId));this.workflowExecutionLogRecords=[...this.workflowExecutionLogRecords,...i.items];this.rootBlocks=o;this.blocks=this.sortByTimestamp(n)};this.createBlocks=t=>{const s=t.filter((t=>t.eventName=="Started"));const e=t.filter((t=>t.eventName=="Completed"));const i=t.filter((t=>t.eventName=="Faulted"));const n=t.filter((t=>t.eventName=="Suspended"));const o=s.map((t=>{const s=e.find((s=>s.activityInstanceId==t.activityInstanceId));const o=i.find((s=>s.activityInstanceId==t.activityInstanceId));const l=n.find((s=>s.activityInstanceId==t.activityInstanceId));const a=!!s?p(s.timestamp,t.timestamp):null;return{nodeId:t.nodeId,activityId:t.activityId,activityInstanceId:t.activityInstanceId,parentActivityInstanceId:t.parentActivityInstanceId,completed:!!s,faulted:!!o,suspended:!!l,timestamp:t.timestamp,duration:a,startedRecord:t,completedRecord:s,faultedRecord:o,suspendedRecord:l,children:[]}}));for(const t of o)t.children=this.findChildBlocks(o,t.activityInstanceId);return o};this.findChildBlocks=(t,s)=>{if(t.length==0)return[];return!!s?t.filter((t=>t.parentActivityInstanceId==s)):t.filter((t=>!t.parentActivityInstanceId))};this.onBlockClick=(t,s)=>{t.preventDefault();const e=this.expandedBlocks.find((t=>t==s));this.expandedBlocks=e?this.expandedBlocks.filter((t=>t!=e)):[...this.expandedBlocks,s]};this.onJournalItemClick=async(t,s,e)=>{t.preventDefault();this.journalItemSelected.emit({activity:e,executionEventBlock:s,activityNode:this.journalActivityMap[s.nodeId]})};this.model=undefined;this.workflowExecutionLogRecords=[];this.blocks=[];this.rootBlocks=[];this.expandedBlocks=[];this.journalActivityMap=new Set;this.iconRegistry=r.get(c);this.workflowInstancesApi=r.get(m)}async onWorkflowInstanceModelChanged(t,s){if(t.workflowInstance.id!=s.workflowInstance.id)await this.refresh()}async componentWillLoad(){this.strings=await g(this.element);await this.refresh()}async refresh(){this.rootBlocks=[];await this.loadJournalPage(0);this.createActivityMapForJournal()}render(){return s("div",{class:"tw-absolute tw-inset-0 tw-overflow-hidden"},s("div",{class:"tw-h-full tw-flex tw-flex-col tw-bg-white tw-shadow-xl"},s("div",{class:"tw-flex tw-flex-col tw-flex-1"},s("div",{class:"tw-px-4 tw-py-6 tw-bg-gray-50 sm:tw-px-6"},s("div",{class:"tw-flex tw-items-start tw-justify-between tw-space-x-3"},s("div",{class:"tw-space-y-1"},s("h2",{class:"tw-text-lg tw-font-medium tw-text-gray-900"},this.strings.worfklowJournal)))),s("div",{class:"tw-flex-1 tw-relative"},s("div",{class:"tw-absolute tw-inset-0 tw-overflow-y-scroll"},s("table",{class:"workflow-journal-table"},s("thead",null,s("tr",null,s("th",{class:"tw-w-1"}),s("th",null,this.strings.time),s("th",{class:"tw-min-w-full"},this.strings.activity),s("th",null,this.strings.status),s("th",null,this.strings.duration))),s("tbody",{class:"tw-bg-white tw-divide-y tw-divide-gray-100"},this.renderBlocks(this.rootBlocks))))))))}sortByTimestamp(t){return t.sort((function(t,s){if(t.timestamp>s.timestamp)return 1;return-1}))}createActivityMapForJournal(){const t=this.model.workflowDefinition;const s={type:"Elsa.Workflow",version:t.version,id:"Workflow1",root:t.root,variables:t.variables,metadata:{},customProperties:{}};const e=v(s);const i=x(e);const n=new Set;for(const t of i)n[t.nodeId]=t;this.journalActivityMap=n;this.blocks=this.blocks.filter((t=>!!n[t.nodeId]))}get element(){return e(this)}static get watchers(){return{model:["onWorkflowInstanceModelChanged"]}}};C.style=j;export{y as elsa_activity_properties,k as elsa_workflow_instance_properties,C as elsa_workflow_journal};
//# sourceMappingURL=p-d28a129d.entry.js.map